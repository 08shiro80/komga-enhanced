name: Release

on:
  workflow_dispatch:
    inputs:
      komga_version:
        description: 'Upstream Komga version (e.g., 1.23.6)'
        type: string
        required: true
        default: '1.23.6'
      fork_version:
        description: 'Fork version (e.g., 0.0.5)'
        type: string
        required: true
      release_notes:
        description: Release notes (use \n for newlines)
        type: string
        required: false
      github_release:
        description: 'Create Github Release'
        default: true
        type: boolean
      docker_release:
        description: 'Push Docker images'
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version_current: ${{ steps.versions.outputs.version_current }}
      version_next: ${{ steps.versions.outputs.version_next }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get previous version
        id: versions
        run: |
          # Get latest tag as current version, or 0.0.0 if no tags exist
          CURRENT=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          # Construct full version: {komga_version}-fork-{fork_version}
          NEXT="${{ inputs.komga_version }}-fork-${{ inputs.fork_version }}"
          echo "version_current=$CURRENT" >> $GITHUB_OUTPUT
          echo "version_next=$NEXT" >> $GITHUB_OUTPUT
          echo "Previous version: $CURRENT"
          echo "New version: $NEXT"

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Remove unnecessary files
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display versions
        run: |
          echo "Previous version: ${{ needs.version.outputs.version_current }}"
          echo "New version: ${{ needs.version.outputs.version_next }}"

      - name: Update version in gradle.properties
        run: sed -i -e "s/version=.*/version=${{ needs.version.outputs.version_next }}/" gradle.properties

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: komga-webui/package-lock.json

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          java-package: 'jdk'
          distribution: 'temurin'

      - name: Set up QEMU
        if: inputs.docker_release
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: inputs.docker_release
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: inputs.docker_release
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build
        run: ./gradlew :komga:prepareThymeLeaf :komga:bootJar
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Commit version change via API (verified)
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Get current file content and SHA
          FILE_SHA=$(gh api repos/${{ github.repository }}/contents/gradle.properties --jq '.sha')

          # Get new content (base64 encoded)
          NEW_CONTENT=$(base64 -w 0 gradle.properties)

          # Create commit via API (will be verified)
          gh api repos/${{ github.repository }}/contents/gradle.properties \
            -X PUT \
            -f message="chore(release): ${{ needs.version.outputs.version_next }}" \
            -f content="$NEW_CONTENT" \
            -f sha="$FILE_SHA" \
            -f branch="${{ github.ref_name }}"

      - name: Create tag via API (verified)
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          VERSION="${{ needs.version.outputs.version_next }}"

          # Delete existing tag if present
          gh api repos/${{ github.repository }}/git/refs/tags/${VERSION} -X DELETE 2>/dev/null || true

          # Get the latest commit SHA
          COMMIT_SHA=$(gh api repos/${{ github.repository }}/commits/${{ github.ref_name }} --jq '.sha')

          # Create the tag object
          TAG_SHA=$(gh api repos/${{ github.repository }}/git/tags \
            -X POST \
            -f tag="${VERSION}" \
            -f message="Release ${VERSION}" \
            -f object="$COMMIT_SHA" \
            -f type="commit" \
            --jq '.sha')

          # Create the tag reference
          gh api repos/${{ github.repository }}/git/refs \
            -X POST \
            -f ref="refs/tags/${VERSION}" \
            -f sha="$TAG_SHA"

      - name: Pull latest changes
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Reset local gradle.properties to match what we just committed via API
          git checkout gradle.properties
          git pull origin ${{ github.ref_name }}

      - name: Prepare release JAR
        id: prepare_jar
        run: |
          VERSION="${{ needs.version.outputs.version_next }}"
          JAR_PATH="komga/build/libs/komga-${VERSION}.jar"
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "jar_name=komga-${VERSION}.jar" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: inputs.github_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.version_next }}
          name: Release ${{ needs.version.outputs.version_next }}
          body: |
            ${{ inputs.release_notes }}

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ needs.version.outputs.version_current }}...${{ needs.version.outputs.version_next }}
          files: |
            ${{ steps.prepare_jar.outputs.jar_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Docker build
        if: inputs.docker_release
        run: |
          JAR_PATH="${{ steps.prepare_jar.outputs.jar_path }}"
          JAR_NAME="${{ steps.prepare_jar.outputs.jar_name }}"

          # Create build context
          mkdir -p docker-build/assembly
          cp "${JAR_PATH}" docker-build/assembly/

          # Create Dockerfile from template
          sed "s/{{distributionArtifactFile}}/${JAR_NAME}/g" komga/docker/Dockerfile.tpl > docker-build/Dockerfile

      - name: Build and push Docker images
        if: inputs.docker_release
        uses: docker/build-push-action@v5
        with:
          context: docker-build
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: |
            08shiro80/komga:latest
            08shiro80/komga:${{ needs.version.outputs.version_next }}
